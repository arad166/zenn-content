---
title: "LabVIEWで3D迷路を作る"
emoji: "🐟"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: []
published: false
---

# 0.はじめに
LabVIEWに慣れるために、LabVIEWで3D迷路を作りました。
![](/images/labview-3dmaze/3dmaze.gif)
*これです*

この記事はその作成過程と学んだことをまとめたものです。
Githubリポジトリは[こちら](https://github.com/arad166/LabVIEW_3Dmaze)です。

# 1. 迷路の実装
## 1.1 迷路のランダム生成
最終的には一人称視点の3D迷路を作りますが、その前段階として2Dで迷路を生成します。
迷路生成にはさまざまなアルゴリズムがありますが、今回は実装が比較的シンプルな**穴掘り法**を選びました。
**穴掘り法**とは、
「ランダムに掘り進め、行き止まりにぶつかったら戻る」
という操作を繰り返して迷路を作るアルゴリズムです。
![](/images/labview-3dmaze/maze1.png)
*このような迷路が生成されます（白が通路、黒が壁）*

この段階では通路を`0` 、壁を`1`とした二次元配列を用意し、それをIntensity Graphで描画しています。

アルゴリズム自体は再帰で実装できます。具体的には「ランダムに掘り進める処理」をサブVI化し、そのサブVIが自分自身を呼び出すようにします。
※自分自身を呼び出すには、`File > VI Properties > Execution`から`Reentrancy`を`Shared clone reentrant execution`に設定しておく必要があります。

## 1.2 迷路の変換と描画

これで迷路は生成できましたが、今後の実装のために「0/1の行列」ではなく「壁の集合」として管理する形に変えます。
方法はシンプルで、通路と壁の境界、そして外周に壁を配置すればよいです。

実装では、壁を「線分」として

$$
(x_1,y_1) \rightarrow (x_2,y_2)
$$

を表す配列 $(x_1, y_1, x_2, y_2)$ の形で管理しました。
迷路は「線分の集合」として表現できるので、二次元配列にこれらの線分を格納して管理しました。

この線分の集合を描画したいところですが、LabVIEW には（私の知る限り）複数の線分を直接描画する関数が存在しません。
そこで代替手段として、線分上に等間隔で点を10個打ち、点列として描画する方法を取りました。
![](/images/labview-3dmaze/maze2.png)
*XY graphで描画するとこのようになります。*

# 2. プレイヤーの実装
## 2.1 プレイヤーの状態管理

プレイヤーの情報としては
- $x$: x座標
- $y$: y座標
- $\theta$: 向き

の3つがあれば十分なので、この $(x,y,\theta)$ をクラスタ化して保持します。例えば、$(2,4,\pi/2)$ はプレイヤーが $(2,4)$ にいて、x軸正の向きに対して $\pi/2$ 回転している状態を表します。
![](/images/labview-3dmaze/x_y_theta.png)

これらの情報をキーボードの十字キー入力によって変更できるようにします。

左キー・右キーはそれぞれプレイヤーの左回転・右回転に対応し、$\theta$ の値を増減させることで実現します。

上キー・下キーは前進・後退に割り当てます。1フレームで距離 $v$ だけ移動する場合、前進なら $x$ 座標に $v\cos\theta$、$y$ 座標に $v\sin\theta$ を加算します。後退の場合は、それぞれ減算します。

## 2.2 プレイヤーと壁の当たり判定

続いて、プレイヤーと壁の当たり判定を実装します。
直前のフレームの座標 $(x_{prev},y_{prev})$ と移動直後の座標 $(x_{now},y_{now})$ を端点とする線分を考えます。この線分がどの壁とも交点を持たなければ、移動を許可します。逆に、どれか1つでも壁と交差していれば、その移動は無効として元の位置に戻します。



線分ABと線分CDが交差しているかどうかは、次の2つの条件を両方満たすかどうかで判定できます。

1. 直線ABによって平面が2分されるとき、点Cと点Dがその両側に位置する（異なる領域に属する）
2. 直線CDによって平面が2分されるとき、点Aと点Bがその両側に位置する（異なる領域に属する）

この2つの条件がともに成立すれば、線分ABと線分CDは交差していると判断できます。

### 2.3 迷路上へのプレイヤー描画

プレイヤーを迷路上に描画し、これまでの実装が正しいかを確認します。プレイヤーの位置情報として $x$ 座標、$y$ 座標、さらに向きを表す $\theta$ が必要です。これらを表現するため、プレイヤーは矢印で表現します。矢印は回転行列を用いて $\theta$ の角度に合わせて回転させることで、プレイヤーの向きを描画できます。

![](/images/labview-3dmaze/maze_with_player.gif)
*プレイヤー描画後*

# 3. 一人称視点の実装
最後に、一人称視点の画面を**レイキャスティング法**を用いて実装します。

**レイキャスティング法**について簡単に説明すると、プレイヤーの位置から複数の方向に光線（レイ）を発射し、それぞれの光線が最初にどの壁と交差するか、またその交点までの距離を計算します。この距離情報をもとに、画面上に壁の高さや奥行きを表現することで、一人称視点の疑似3D表示を実現します。

具体的には、画面の各列に対応する角度で光線を飛ばし、最も近い壁との交点までの距離を求めます。距離が近いほど壁は高く、遠いほど低く描画されるため、これを利用して奥行き感を表現します。

![](/images/labview-3dmaze/lay_casting.png)

実装方法を簡単に説明します。  
まず、プレイヤーの位置から各角度ごとに光線を発射します。各光線は十分に長い線分として扱い、迷路内のすべての壁との交点を計算します（光線と交点を持たない壁は無視して良いです）。その中で最も近い交点までの距離を求め、その値を元に画面上の壁の高さを計算します。これを画面の各列ごとに繰り返すことで、一人称視点の3D風表示が実現できます。

# 4. 完成
ミニマップと操作方法の説明を作れば完成です。
ミニマップは全体のマップの表示範囲を動的に変えることで実装できます。

![](/images/labview-3dmaze/3dmaze.gif)

LabVIEWの基礎を学ぶには良い題材だと思うので、是非作ってみてください。